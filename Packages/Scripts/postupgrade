#!/bin/bash

###############################################################################
# Claude Secrets Manager - Package Post-Upgrade Script  
# Runs after package upgrade to preserve user configurations
# This script is called automatically when upgrading an existing installation
###############################################################################

set -e

# Package installer environment
PACKAGE_PATH="$1"
DESTINATION_PATH="$2"
DESTINATION_VOLUME="$3"
ROOT_PATH="$4"

echo "â¬†ï¸  Claude Secrets Manager - Post-Upgrade"
echo "=========================================="
echo "Package: $PACKAGE_PATH"
echo "Destination: $DESTINATION_PATH"
echo "Volume: $DESTINATION_VOLUME"
echo "Root: $ROOT_PATH"

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Verify pre-installation ran successfully
if [[ ! -f "/tmp/claudesecrets-install-state" ]]; then
    echo "âŒ Installation state not found. Pre-installation may have failed."
    exit 1
fi

if [[ ! -f "/tmp/claudesecrets-user-env" ]]; then
    echo "âŒ User environment not found. Pre-installation may have failed."
    exit 1
fi

# Source the states
source "/tmp/claudesecrets-install-state"
source "/tmp/claudesecrets-user-env"

echo ""
echo "ğŸ” Upgrade Analysis:"
echo "   â€¢ User: $LOGIN"
echo "   â€¢ Secrets preserved: $([ "$PRESERVE_SECRETS" == "true" ] && echo "YES" || echo "NO")"
echo "   â€¢ Template preserved: $([ "$PRESERVE_TEMPLATE" == "true" ] && echo "YES" || echo "NO")"
echo "   â€¢ Config backed up: $([ "$EXISTING_CONFIG" == "true" ] && echo "YES" || echo "NO")"

echo ""
echo "ğŸ› ï¸  Performing upgrade-specific tasks..."

# Check if daemon is currently running and stop it
PLIST_PATH="$LOGINHOMEDIR/Library/LaunchAgents/com.oemden.claudesecrets.plist"
DAEMON_WAS_RUNNING=false

if launchctl list | grep -q "com.oemden.claudesecrets"; then
    echo "   ğŸ›‘ Stopping existing daemon for upgrade..."
    sudo -u "$LOGIN" launchctl unload "$PLIST_PATH" 2>/dev/null || true
    DAEMON_WAS_RUNNING=true
    sleep 2
    echo "   âœ… Daemon stopped"
fi

echo ""
echo "ğŸ”§ Running enhanced installation for upgrade..."

# Run enhanced installation (same as fresh install, but with preserved files)
if [[ -f "$SCRIPT_DIR/enhanced-install.sh" ]]; then
    bash "$SCRIPT_DIR/enhanced-install.sh"
    if [[ $? -eq 0 ]]; then
        echo "âœ… Enhanced installation completed successfully"
    else
        echo "âŒ Enhanced installation failed"
        exit 1
    fi
else
    echo "âŒ Enhanced installation script not found: $SCRIPT_DIR/enhanced-install.sh"
    exit 1
fi

echo ""
echo "ğŸ”„ Post-upgrade binary updates..."

# Ensure new binaries have correct permissions
if [[ -f "/usr/local/bin/claudesecrets" ]]; then
    chmod +x "/usr/local/bin/claudesecrets"
    echo "   âœ… Updated claudesecrets binary permissions"
fi

if [[ -f "/usr/local/bin/claudesecrets-cli" ]]; then
    chmod +x "/usr/local/bin/claudesecrets-cli"
    echo "   âœ… Updated claudesecrets-cli binary permissions"
fi

# Update LaunchAgent plist with new binary paths (in case they changed)
if [[ -f "$PLIST_PATH" ]]; then
    # Ensure plist points to correct binary location
    sed -i '' 's|<string>/opt/dev/bin/claudesecrets</string>|<string>/usr/local/bin/claudesecrets</string>|g' "$PLIST_PATH"
    chown "$LOGIN:staff" "$PLIST_PATH"
    chmod 644 "$PLIST_PATH"
    echo "   âœ… Updated LaunchAgent plist"
fi

# Restart daemon if it was running before upgrade
if [[ "$DAEMON_WAS_RUNNING" == "true" ]]; then
    echo ""
    echo "ğŸš€ Restarting daemon after upgrade..."
    sleep 1
    sudo -u "$LOGIN" launchctl load -w "$PLIST_PATH" 2>/dev/null || true
    sleep 2
    
    # Verify daemon started
    if launchctl list | grep -q "com.oemden.claudesecrets"; then
        echo "   âœ… Daemon restarted successfully"
    else
        echo "   âš ï¸  Daemon may need manual restart: claudesecrets-cli --enable"
    fi
fi

# Check if new CLI features are available
echo ""
echo "ğŸ†• Checking for new features..."

if /usr/local/bin/claudesecrets-cli --help | grep -q "wipesecrets"; then
    echo "   âœ… Emergency recovery features available"
fi

if /usr/local/bin/claudesecrets-cli --help | grep -q "migrate"; then
    echo "   âœ… Migration features available"
fi

if /usr/local/bin/claudesecrets-cli --help | grep -q "noclaudesecrets"; then
    echo "   âœ… Emergency disable features available"
fi

echo ""
echo "ğŸ§¹ Cleaning up upgrade artifacts..."

# Clean up temporary files
rm -f "/tmp/claudesecrets-install-state" 2>/dev/null || true
rm -f "/tmp/claudesecrets-user-env" 2>/dev/null || true
echo "   âœ… Temporary files cleaned up"

echo ""
echo "ğŸ‰ Upgrade Summary" 
echo "=================="
echo "âœ… Claude Secrets Manager upgraded successfully!"
echo ""
echo "ğŸ”’ User Configurations:"
echo "   â€¢ Existing secrets: $([ "$PRESERVE_SECRETS" == "true" ] && echo "preserved" || echo "none found")"
echo "   â€¢ Existing template: $([ "$PRESERVE_TEMPLATE" == "true" ] && echo "preserved" || echo "none found")"
echo "   â€¢ Service status: $([ "$DAEMON_WAS_RUNNING" == "true" ] && echo "restarted" || echo "stopped")"

if [[ -n "$BACKUP_DIR" && -d "$BACKUP_DIR" ]]; then
    echo "   â€¢ New backups: $BACKUP_DIR"
fi

echo ""
echo "ğŸ“‹ What's New in This Version:"
echo "   â€¢ Enhanced emergency recovery commands"
echo "   â€¢ File-to-keychain migration support" 
echo "   â€¢ Improved backup and failsafe protection"
echo "   â€¢ Better user permission handling"

echo ""
echo "ğŸš€ Post-Upgrade Actions:"
echo "   1. Check status: claudesecrets-cli --status"
echo "   2. View new features: claudesecrets-cli --help"
echo "   3. Test functionality: Launch Claude Desktop/Code"

# Voice notification for upgrade completion
if command -v say >/dev/null 2>&1; then
    say "Claude Secrets Manager upgrade complete" &
fi

echo ""
echo "âœ… Post-upgrade complete!"

exit 0
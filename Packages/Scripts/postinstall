#!/bin/bash

###############################################################################
# Claude Secrets Manager - Package Post-Installation Script
# Runs after package installation to complete setup
# This script is called automatically by the macOS installer
###############################################################################

set -e

# Package installer environment
PACKAGE_PATH="$1"
DESTINATION_PATH="$2"
DESTINATION_VOLUME="$3" 
ROOT_PATH="$4"

echo "ðŸŽ¯ Claude Secrets Manager - Post-Installation"
echo "=============================================="
echo "Package: $PACKAGE_PATH"
echo "Destination: $DESTINATION_PATH"
echo "Volume: $DESTINATION_VOLUME"
echo "Root: $ROOT_PATH"

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Verify pre-installation ran successfully
if [[ ! -f "/tmp/claudesecrets-install-state" ]]; then
    echo "âŒ Installation state not found. Pre-installation may have failed."
    exit 1
fi

if [[ ! -f "/tmp/claudesecrets-user-env" ]]; then
    echo "âŒ User environment not found. Pre-installation may have failed." 
    exit 1
fi

echo ""
echo "ðŸ”§ Running enhanced installation..."

# Run enhanced installation script
if [[ -f "$SCRIPT_DIR/enhanced-install.sh" ]]; then
    bash "$SCRIPT_DIR/enhanced-install.sh"
    if [[ $? -eq 0 ]]; then
        echo "âœ… Enhanced installation completed successfully"
    else
        echo "âŒ Enhanced installation failed"
        exit 1
    fi
else
    echo "âŒ Enhanced installation script not found: $SCRIPT_DIR/enhanced-install.sh"
    exit 1
fi

# Source the installation state to get user info
source "/tmp/claudesecrets-install-state"

echo ""
echo "âš™ï¸  Processing user installation choices..."

# Handle user choices from installer
if [[ -f "$SCRIPT_DIR/handle-user-choices.sh" ]]; then
    bash "$SCRIPT_DIR/handle-user-choices.sh"
    if [[ $? -eq 0 ]]; then
        echo "âœ… User choices processed successfully"
    else
        echo "âš ï¸  User choice processing had issues (continuing installation)"
    fi
else
    echo "âš ï¸  User choice handler not found (using defaults)"
fi

echo ""
echo "ðŸ”§ Final permission adjustments..."

# Ensure all installed binaries have correct permissions
if [[ -f "/usr/local/bin/claudesecrets" ]]; then
    chmod +x "/usr/local/bin/claudesecrets"
    echo "   âœ… claudesecrets binary: executable"
fi

if [[ -f "/usr/local/bin/claudesecrets-cli" ]]; then
    chmod +x "/usr/local/bin/claudesecrets-cli"
    echo "   âœ… claudesecrets-cli binary: executable"
fi

# Ensure LaunchAgent plist has correct permissions  
PLIST_PATH="$LOGINHOMEDIR/Library/LaunchAgents/com.oemden.claudesecrets.plist"
if [[ -f "$PLIST_PATH" ]]; then
    chown "$LOGIN:staff" "$PLIST_PATH"
    chmod 644 "$PLIST_PATH"
    echo "   âœ… LaunchAgent plist: correct permissions"
fi

echo ""
echo "ðŸ§¹ Cleaning up temporary files..."

# Clean up temporary files
rm -f "/tmp/claudesecrets-install-state" 2>/dev/null || true
rm -f "/tmp/claudesecrets-user-env" 2>/dev/null || true
echo "   âœ… Temporary files cleaned up"

echo ""
echo "ðŸŽ‰ Installation Summary"
echo "======================="

# Show installation results
echo "âœ… Claude Secrets Manager installed successfully!"
echo ""
echo "ðŸ“ Installation Details:"
echo "   â€¢ User: $LOGIN"
echo "   â€¢ Home: $LOGINHOMEDIR"
echo "   â€¢ Daemon: /usr/local/bin/claudesecrets"
echo "   â€¢ CLI: /usr/local/bin/claudesecrets-cli"
echo "   â€¢ LaunchAgent: ~/Library/LaunchAgents/com.oemden.claudesecrets.plist"

# Read final state
if [[ -f "/tmp/claudesecrets-install-state" ]]; then
    source "/tmp/claudesecrets-install-state"
    
    echo ""
    echo "ðŸ“‹ Configuration Status:"
    if [[ "$PRESERVE_SECRETS" == "true" ]]; then
        echo "   â€¢ Secrets file: preserved from previous installation"
    else
        echo "   â€¢ Secrets file: created new template"
    fi
    
    if [[ "$PRESERVE_TEMPLATE" == "true" ]]; then
        echo "   â€¢ Template file: preserved from previous installation" 
    else
        echo "   â€¢ Template file: created from current Claude config"
    fi
    
    if [[ -n "$BACKUP_DIR" && -d "$BACKUP_DIR" ]]; then
        echo "   â€¢ Backups: $BACKUP_DIR"
    fi
fi

echo ""
echo "ðŸš€ Next Steps:"
echo "   1. Open Terminal and run: claudesecrets-cli --help"
echo "   2. Configure your secrets: claudesecrets-cli --add API_KEY=your_key"
echo "   3. Start the service: claudesecrets-cli --enable"
echo "   4. Check status: claudesecrets-cli --status"
echo ""
echo "ðŸ“– For detailed instructions, see the README.md file"
echo "ðŸ”— Documentation: https://github.com/yourrepo/claude-secrets-manager"

# Optional: Show important file locations to user
echo ""
echo "ðŸ“ Important File Locations:"
echo "   â€¢ Secrets: $LOGINHOMEDIR/.claudesecrets/.claude_secrets"
echo "   â€¢ Template: $LOGINHOMEDIR/Library/Application Support/Claude/claude_desktop_config_template.json"
echo "   â€¢ Claude Config: $LOGINHOMEDIR/Library/Application Support/Claude/claude_desktop_config.json"

# Voice notification (if available and user has sound on)
if command -v say >/dev/null 2>&1; then
    say "Claude Secrets Manager installation complete" &
fi

echo ""
echo "âœ… Post-installation complete!"

exit 0
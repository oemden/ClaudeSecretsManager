#!/bin/bash

###############################################################################
# Claude Secrets Manager - Package Post-Installation Script - Version "0.3.1"
# Follows standard macOS package installer patterns
# Based on XCreds postinstall.sh structure
###############################################################################

set -x

# Standard package installer parameters
PACKAGE_PATH="${1}"
TARGET="${2}"       # Target path (destination) 
TARGET_VOLUME="${3}" # Target volume

echo "üéØ Claude Secrets Manager - Post-Installation"
echo "=============================================="
echo "Package: $PACKAGE_PATH"
echo "Target: $TARGET"
echo "Volume: $TARGET_VOLUME"

# Function to detect console user (XCreds pattern)
detect_console_user() {
    local console_user=""
    console_user=$(/bin/ls -l /dev/console 2>/dev/null | /usr/bin/awk '{ print $3 }')
    if [[ -n "$console_user" && "$console_user" != "root" ]]; then
        echo "$console_user"
    else
        # Fallback: try who command
        console_user=$(who | grep console | awk '{ print $1 }' | head -1)
        echo "$console_user"
    fi
}



# Function to get user home directory
get_user_home() {
    local username="$1"
    local user_home=""
    user_home=$(dscl . -read "/Users/$username" NFSHomeDirectory 2>/dev/null | awk '{print $2}')
    if [[ -z "$user_home" ]]; then
        user_home="/Users/$username"
    fi
    echo "$user_home"
}

# Detect the console user
CONSOLE_USER=$(detect_console_user)
if [[ -z "$CONSOLE_USER" || "$CONSOLE_USER" == "root" ]]; then
    echo "‚ö†Ô∏è  Warning: Could not detect console user, using fallback"
    CONSOLE_USER="$(ls /Users | grep -v Shared | head -1)"
fi

echo "üë§ Detected console user: $CONSOLE_USER"

# Get user home directory
USER_HOME=$(get_user_home "$CONSOLE_USER")
echo "üè† User home directory: $USER_HOME"

# echo ""
# echo "üì¶ Moving binaries from /tmp to final locations..."

# # Move daemon binary from /tmp/ClaudeSecretsManager to /usr/local/bin
# if [[ -f "/tmp/ClaudeSecretsManager/claudesecrets" ]]; then
#     mkdir -p "${TARGET}/usr/local/bin"
#     cp "/tmp/ClaudeSecretsManager/claudesecrets" "${TARGET}/usr/local/bin/"
#     chmod +x "${TARGET}/usr/local/bin/claudesecrets"
#     chown root:wheel "${TARGET}/usr/local/bin/claudesecrets"
#     rm -f "/tmp/ClaudeSecretsManager/claudesecrets"
#     echo "   ‚úÖ claudesecrets daemon installed to /usr/local/bin"
# else
#     echo "   ‚ùå claudesecrets binary not found in /tmp/ClaudeSecretsManager"
#     exit 1
# fi

# # Move CLI binary from /tmp/ClaudeSecretsManager to /usr/local/bin  
# if [[ -f "/tmp/ClaudeSecretsManager/claudesecrets-cli" ]]; then
#     cp "/tmp/ClaudeSecretsManager/claudesecrets-cli" "${TARGET}/usr/local/bin/"
#     chmod +x "${TARGET}/usr/local/bin/claudesecrets-cli"
#     chown root:wheel "${TARGET}/usr/local/bin/claudesecrets-cli"
#     rm -f "/tmp/ClaudeSecretsManager/claudesecrets-cli"
#     echo "   ‚úÖ claudesecrets-cli installed to /usr/local/bin"
# else
#     echo "   ‚ùå claudesecrets-cli binary not found in /tmp/ClaudeSecretsManager"
#     exit 1
# fi

echo ""
echo "üîß Setting up LaunchAgent..."

# Move LaunchAgent plist to user's LaunchAgents directory
LAUNCHAGENTS_DIR="${USER_HOME}/Library/LaunchAgents"
PLIST_PATH="${LAUNCHAGENTS_DIR}/com.oemden.claudesecrets.plist"

if [[ -f "/tmp/ClaudeSecretsManager/com.oemden.claudesecrets.plist" ]]; then
    # Create LaunchAgents directory if it doesn't exist
    if [[ ! -d "$LAUNCHAGENTS_DIR" ]]; then
        mkdir -p "$LAUNCHAGENTS_DIR"
        chown "$CONSOLE_USER:staff" "$LAUNCHAGENTS_DIR"
        chmod 755 "$LAUNCHAGENTS_DIR"
    fi
    
    # Copy plist to user's LaunchAgents directory
    cp "/tmp/ClaudeSecretsManager/com.oemden.claudesecrets.plist" "$PLIST_PATH"
    chown "$CONSOLE_USER:staff" "$PLIST_PATH"
    chmod 644 "$PLIST_PATH"
    rm -f "/tmp/ClaudeSecretsManager/com.oemden.claudesecrets.plist"
    # Enable the daemon
    echo "   ‚úÖ LaunchAgent plist installed: $PLIST_PATH"
    echo "üöÄ Enabling LaunchAgent..."
    sudo -u "$CONSOLE_USER" launchctl load -w "$PLIST_PATH"
    echo "   ‚úÖ LaunchAgent enabled and started"

else
    echo "   ‚ùå LaunchAgent plist not found in /tmp/ClaudeSecretsManager"
    exit 1
fi

echo ""
echo "üìÅ Creating configuration directories and files (if missing)..."

# Create .claudesecrets directory
SECRETS_DIR="${USER_HOME}/.claudesecrets"
if [[ ! -d "$SECRETS_DIR" ]]; then
    mkdir -p "$SECRETS_DIR"
    chown "$CONSOLE_USER:staff" "$SECRETS_DIR"
    chmod 700 "$SECRETS_DIR"
    echo "   ‚úÖ Created secrets directory: $SECRETS_DIR"
fi

# Create secrets file (ONLY if it doesn't exist)
SECRETS_FILE="${SECRETS_DIR}/.claude_secrets"
if [[ ! -f "$SECRETS_FILE" ]]; then
    cat > "$SECRETS_FILE" << 'EOF'
# Claude Secrets Manager - Secrets File
# Format: KEY=VALUE or export KEY=VALUE
# 
# Example API keys:
# OPENAI_API_KEY=your_openai_api_key_here
# ANTHROPIC_API_KEY=your_anthropic_api_key_here
# GOOGLE_API_KEY=your_google_api_key_here
#
# Add your secrets below:

EOF
    chown "$CONSOLE_USER:staff" "$SECRETS_FILE"
    chmod 600 "$SECRETS_FILE"
    echo "   ‚úÖ Created secrets file: $SECRETS_FILE"
else
    echo "   üõ°Ô∏è  Existing secrets file preserved: $SECRETS_FILE"
fi

# Create Claude config directory if needed
CLAUDE_CONFIG_DIR="${USER_HOME}/Library/Application Support/Claude"
if [[ ! -d "$CLAUDE_CONFIG_DIR" ]]; then
    mkdir -p "$CLAUDE_CONFIG_DIR"
    chown "$CONSOLE_USER:staff" "$CLAUDE_CONFIG_DIR"
    chmod 755 "$CLAUDE_CONFIG_DIR"
    echo "   ‚úÖ Created Claude config directory"
fi

# Create template file (ONLY if it doesn't exist)
TEMPLATE_FILE="${CLAUDE_CONFIG_DIR}/claude_desktop_config_template.json"
CONFIG_FILE="${CLAUDE_CONFIG_DIR}/claude_desktop_config.json"

if [[ ! -f "$TEMPLATE_FILE" ]]; then
    if [[ -f "$CONFIG_FILE" ]]; then
        # Use existing config as template base
        cp "$CONFIG_FILE" "$TEMPLATE_FILE"
        echo "   ‚úÖ Created template from existing config: $TEMPLATE_FILE"
    else
        # Create default template
        cat > "$TEMPLATE_FILE" << 'EOF'
{
  "mcpServers": {
    "example": {
      "command": "example-command",
      "args": ["--arg1", "VALUE_FROM_SECRETS"],
      "env": {
        "API_KEY": "OPENAI_API_KEY"
      }
    }
  }
}
EOF
        echo "   ‚úÖ Created default template: $TEMPLATE_FILE"
    fi
    chown "$CONSOLE_USER:staff" "$TEMPLATE_FILE"
    chmod 644 "$TEMPLATE_FILE"
else
    echo "   üõ°Ô∏è  Existing template file preserved: $TEMPLATE_FILE"
fi

# Create complete domain preferences 
echo ""
echo "‚öôÔ∏è  Setting up complete domain preferences..."

# Read existing values for critical keys (if they exist)
EXISTING_SECRETS_FILE=$(sudo -u "$CONSOLE_USER" defaults read com.oemden.claudesecrets secrets_file 2>/dev/null || echo "")
EXISTING_TEMPLATE_FILE=$(sudo -u "$CONSOLE_USER" defaults read com.oemden.claudesecrets template_claudedesktop_config_file 2>/dev/null || echo "")

# Set all domain preferences (complete set)
sudo -u "$CONSOLE_USER" defaults write com.oemden.claudesecrets always_reset_config_at_launch -bool false
sudo -u "$CONSOLE_USER" defaults write com.oemden.claudesecrets always_secure_config -bool true
sudo -u "$CONSOLE_USER" defaults write com.oemden.claudesecrets first_run_claudecode_config_backup_file "~/Library/Application Support/Claude/claude_desktop_config.firstrun.backup.json"
sudo -u "$CONSOLE_USER" defaults write com.oemden.claudesecrets first_run_claudedesktop_config_backup_file "~/Library/Application Support/Claude/claude_desktop_config.firstrun.backup.json"
sudo -u "$CONSOLE_USER" defaults write com.oemden.claudesecrets first_run_done -bool true
sudo -u "$CONSOLE_USER" defaults write com.oemden.claudesecrets macos_notifications -bool true
sudo -u "$CONSOLE_USER" defaults write com.oemden.claudesecrets manage_ClaudeCode_config -bool true
sudo -u "$CONSOLE_USER" defaults write com.oemden.claudesecrets manage_ClaudeDesktop_config -bool true

# Handle secrets_file - preserve existing if it exists, otherwise use default
if [[ -n "$EXISTING_SECRETS_FILE" ]]; then
    sudo -u "$CONSOLE_USER" defaults write com.oemden.claudesecrets secrets_file "$EXISTING_SECRETS_FILE"
    echo "   üõ°Ô∏è  Preserved existing secrets_file: $EXISTING_SECRETS_FILE"
else
    sudo -u "$CONSOLE_USER" defaults write com.oemden.claudesecrets secrets_file "~/.claudesecrets/.claude_secrets"
fi

sudo -u "$CONSOLE_USER" defaults write com.oemden.claudesecrets secrets_mechanism "file"
sudo -u "$CONSOLE_USER" defaults write com.oemden.claudesecrets shareClaudeDesktop_config_withClaudeCode -bool true
sudo -u "$CONSOLE_USER" defaults write com.oemden.claudesecrets target_claudecode_config_file "~/Library/Application Support/Claude/claude_desktop_config.json"
sudo -u "$CONSOLE_USER" defaults write com.oemden.claudesecrets target_claudedesktop_config_file "~/Library/Application Support/Claude/claude_desktop_config.json"

# Handle template_claudedesktop_config_file - preserve existing if it exists, otherwise use default
if [[ -n "$EXISTING_TEMPLATE_FILE" ]]; then
    sudo -u "$CONSOLE_USER" defaults write com.oemden.claudesecrets template_claudedesktop_config_file "$EXISTING_TEMPLATE_FILE"
    echo "   üõ°Ô∏è  Preserved existing template_claudedesktop_config_file: $EXISTING_TEMPLATE_FILE"  
else
    sudo -u "$CONSOLE_USER" defaults write com.oemden.claudesecrets template_claudedesktop_config_file "~/Library/Application Support/Claude/claude_desktop_config_template.json"
fi

sudo -u "$CONSOLE_USER" defaults write com.oemden.claudesecrets template_claudecode_config_file "~/Library/Application Support/Claude/claude_desktop_config_template.json"
sudo -u "$CONSOLE_USER" defaults write com.oemden.claudesecrets voice_notifications -bool true

# Set proper permissions on the preferences file
PREFS_FILE="${USER_HOME}/Library/Preferences/com.oemden.claudesecrets.plist"
if [[ -f "$PREFS_FILE" ]]; then
    chown "$CONSOLE_USER:staff" "$PREFS_FILE"
    chmod 600 "$PREFS_FILE"
    echo "   ‚úÖ Preferences file permissions set: $PREFS_FILE"
fi

echo "   ‚úÖ Complete domain preferences configured"

echo ""
echo "üéâ Installation Complete!"
echo "========================"
echo "‚úÖ Binaries installed: /usr/local/bin/claudesecrets, /usr/local/bin/claudesecrets-cli"
echo "‚úÖ LaunchAgent configured: ~/Library/LaunchAgents/com.oemden.claudesecrets.plist"
echo "‚úÖ Configuration directories created"
echo "üõ°Ô∏è  Existing secrets and templates preserved"
echo ""
echo "üöÄ Quick Start:"
echo "   claudesecrets-cli --help     # Show available commands"
echo "   claudesecrets-cli --status   # Check daemon status"
echo "   claudesecrets-cli --enable   # Start the daemon"
echo ""

# Display Status
/usr/local/bin/claudesecrets-cli --status

# Clean up any remaining temporary files
rm -rf /tmp/ClaudeSecretsManager 2>/dev/null || true

exit 0